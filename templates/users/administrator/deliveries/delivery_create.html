{% extends '../_base.html' %}
{% load i18n %}
{% load crispy_forms_tags %}

{% block title %}{% trans "Create New Delivery" %}{% endblock %}

{% block extra_css %}
<style>
    .timeline-container {
        height: calc(100vh - 2rem);
        overflow-y: auto;
    }
    .form-container {
        height: calc(100vh - 2rem);
        overflow-y: auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="flex flex-col md:flex-row h-screen">
    <!-- Timeline Panel -->
    <div class="w-full md:w-1/4 p-4 bg-white shadow-md rounded-lg px-8 pt-6 pb-8 mb-4">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">{% trans "Delivery Creation Process" %}</h2>
        <ol class="relative border-s border-gray-200 ml-3">
          <li class="mb-10 ms-6">
            <span class="absolute flex items-center justify-center w-8 h-8 bg-blue-500 rounded-full -start-4 ring-4 ring-white">
              <i class="fas fa-info-circle text-white"></i>
            </span>
            <h3 class="flex items-center mb-1 text-lg font-semibold text-gray-800">{% trans "Basic Information" %}
              <span class="bg-blue-500 text-white text-sm font-medium me-2 px-2.5 py-0.5 rounded ms-3">{% trans "Current" %}</span>
            </h3>
            <time class="block mb-2 text-sm font-normal leading-none text-gray-500">{% trans "Step 1 of 4" %}</time>
            <p class="mb-4 text-base font-normal text-gray-600">{% trans "Set up the core details of your delivery, including type, mode, and scheduling." %}</p>
          </li>
          <li class="mb-10 ms-6">
            <span class="absolute flex items-center justify-center w-8 h-8 bg-gray-300 rounded-full -start-4 ring-4 ring-white">
              <i class="fas fa-users text-gray-600"></i>
            </span>
            <h3 class="mb-1 text-lg font-semibold text-gray-800">{% trans "Enrollments" %}</h3>
            <time class="block mb-2 text-sm font-normal leading-none text-gray-500">{% trans "Step 2 of 4" %}</time>
            <p class="text-base font-normal text-gray-600">{% trans "Manage participant enrollments for your delivery." %}</p>
          </li>
          <li class="mb-10 ms-6">
            <span class="absolute flex items-center justify-center w-8 h-8 bg-gray-300 rounded-full -start-4 ring-4 ring-white">
              <i class="fas fa-puzzle-piece text-gray-600"></i>
            </span>
            <h3 class="mb-1 text-lg font-semibold text-gray-800">{% trans "Delivery Components" %}</h3>
            <time class="block mb-2 text-sm font-normal leading-none text-gray-500">{% trans "Step 3 of 4" %}</time>
            <p class="text-base font-normal text-gray-600">{% trans "Set up the components and structure of your delivery." %}</p>
          </li>
          <li class="ms-6">
            <span class="absolute flex items-center justify-center w-8 h-8 bg-gray-300 rounded-full -start-4 ring-4 ring-white">
              <i class="fas fa-envelope text-gray-600"></i>
            </span>
            <h3 class="mb-1 text-lg font-semibold text-gray-800">{% trans "Email Templates" %}</h3>
            <time class="block mb-2 text-sm font-normal leading-none text-gray-500">{% trans "Step 4 of 4" %}</time>
            <p class="text-base font-normal text-gray-600">{% trans "Configure email templates for various delivery notifications." %}</p>
          </li>
        </ol>
      </div>

    <!-- Existing Form Content -->
    <div class="w-full md:w-3/4 form-container">
        <div class="p-4">
            <header class="mb-4 gradient-bg p-6 rounded-lg shadow-md">
                <h1 class="text-4xl font-bold text-white text-center mb-2">{% trans "Create New Delivery" %}</h1>
                <p class="text-lg text-white text-center">{% trans "Set up a new delivery for a course or program." %}</p>
            </header>

            <nav class="flex mb-4" aria-label="{% trans 'Breadcrumb' %}">
                <ol class="inline-flex items-center space-x-1 md:space-x-3">
                    <li class="inline-flex items-center">
                        <a href="{% url 'administrator_dashboard' %}" class="inline-flex items-center text-sm font-medium text-gray-700 hover:text-blue-600">
                            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg>
                            {% trans "Dashboard" %}
                        </a>
                    </li>
                    <li>
                        <div class="flex items-center">
                            <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
                            <a href="{% url 'administrator_delivery_list' %}" class="ml-1 text-sm font-medium text-gray-700 hover:text-blue-600 md:ml-2">{% trans "Deliveries" %}</a>
                        </div>
                    </li>
                    <li>
                        <div class="flex items-center">
                            <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
                            <span class="ml-1 text-sm font-medium text-gray-500 md:ml-2">{% trans "Create Delivery" %}</span>
                        </div>
                    </li>
                </ol>
            </nav>

            <form method="post" id="deliveryForm">
                {% csrf_token %}
                
                <div id="basic_information">
                    {% include './delivery_create_form/basic_information.html' %}
                </div>    
                
                <div id="schedule">
                    {% include './delivery_create_form/schedule.html' %}
                </div>
                
                <div id="delivery_settings">
                    {% include './delivery_create_form/delivery_settings.html' %}
                </div>
                
                <div class="flex mt-6 justify-between">
                    <button class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" type="button" onclick="window.history.back();">
                        {% trans "Back" %}
                    </button>
                    <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" type="submit">
                        {% trans "Proceed to Enrollments" %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const deliveryTypeSelect = document.getElementById('id_delivery_type');
    const deliveryModeSelect = document.getElementById('id_delivery_mode');
    const programField = document.getElementById('programField');
    const courseField = document.getElementById('courseField');
    const instructorsField = document.getElementById('instructorsField');
    const instructorSearch = document.getElementById('instructorSearch');
    const instructorItems = document.querySelectorAll('.instructor-item');

    function updateVisibility() {
        try {
            const deliveryType = deliveryTypeSelect.value;
            const deliveryMode = deliveryModeSelect.value;

            if (deliveryType === 'PROGRAM') {
                programField.classList.remove('hidden');
                courseField.classList.add('hidden');
            } else if (deliveryType === 'COURSE') {
                programField.classList.add('hidden');
                courseField.classList.remove('hidden');
            }

            if (deliveryMode === 'INSTRUCTOR_LED' || deliveryMode === 'BLENDED') {
                instructorsField.classList.remove('hidden');
            } else {
                instructorsField.classList.add('hidden');
            }
        } catch (error) {
            console.error('Error updating visibility:', error);
            // You might want to show an error message to the user here
        }
    }

    function filterInstructors() {
        try {
            const searchTerm = instructorSearch.value.toLowerCase();
            instructorItems.forEach(item => {
                const instructorName = item.textContent.toLowerCase();
                if (instructorName.includes(searchTerm)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        } catch (error) {
            console.error('Error filtering instructors:', error);
            // You might want to show an error message to the user here
        }
    }

    deliveryTypeSelect.addEventListener('change', updateVisibility);
    deliveryModeSelect.addEventListener('change', updateVisibility);
    instructorSearch.addEventListener('input', filterInstructors);

    // Initial update
    updateVisibility();
});
</script>
{% endblock %}