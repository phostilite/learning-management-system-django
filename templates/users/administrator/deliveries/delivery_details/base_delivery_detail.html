{% extends '../../_base.html' %}
{% load i18n %}
{% load crispy_forms_tags %}

{% block title %}{% trans "Delivery Details" %} | {{ delivery.title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
<style>
    .stat-card {
        border-radius: 1rem;
        overflow: hidden;
    }
    .stat-icon {
        font-size: 2rem;
        opacity: 0.2;
        position: absolute;
        right: 1rem;
        top: 1rem;
    }
    .custom-modal-123 {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
    }
    .custom-modal-content-123 {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 500px;
    }
    .custom-close-123 {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }
    .custom-close-123:hover,
    .custom-close-123:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}
<div>
    <header class="mb-4 gradient-bg p-6 rounded-lg shadow-md">
        <h1 class="text-4xl font-bold text-white text-center mb-2">{{ delivery.title }}</h1>
        <p class="text-lg text-white text-center">{% trans "Delivery Details and Components" %}</p>
    </header>

    <nav class="flex mb-4" aria-label="{% trans 'Breadcrumb' %}">
        <ol class="inline-flex items-center space-x-1 md:space-x-3">
            <li class="inline-flex items-center">
                <a href="{% url 'administrator_dashboard' %}" class="inline-flex items-center text-sm font-medium text-gray-700 hover:text-blue-600">
                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg>
                    {% trans "Dashboard" %}
                </a>
            </li>
            <li>
                <div class="flex items-center">
                    <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
                    <a href="{% url 'administrator_delivery_list' %}" class="ml-1 text-sm font-medium text-gray-700 hover:text-blue-600 md:ml-2">{% trans "Deliveries" %}</a>
                </div>
            </li>
            <li>
                <div class="flex items-center">
                    <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
                    <span class="ml-1 text-sm font-medium text-gray-700 md:ml-2">{{ delivery.get_delivery_type_display }}</span>
                </div>
            </li>
            <li>
                <div class="flex items-center">
                    <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
                    {% if delivery.delivery_type == 'PROGRAM' %}
                        <a href="{% url 'administrator_program_detail' delivery.program.id %}" class="ml-1 text-sm font-medium text-gray-700 hover:text-blue-600 md:ml-2">{{ delivery.program.title }}</a>
                    {% else %}
                        <a href="{% url 'administrator_course_detail' delivery.course.id %}" class="ml-1 text-sm font-medium text-gray-700 hover:text-blue-600 md:ml-2">{{ delivery.course.title }}</a>
                    {% endif %}
                </div>
            </li>
            <li>
                <div class="flex items-center">
                    <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
                    <span class="ml-1 text-sm font-medium text-gray-500 md:ml-2">{{ delivery.title }}</span>
                </div>
            </li>
        </ol>
    </nav>

    <main class="w-full mx-auto">
        {% include './delivery_info.html' %}

        {% if delivery.delivery_type == 'PROGRAM' %}
            {% include './program_details.html' %}
            
        {% elif delivery.delivery_type == 'COURSE' %}
            {% include './course_details.html' %}
        {% endif %}

        {% include '../course_component_form.html' %}
        {% include '../resource_to_course_component_form.html' %}


        


    </main>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Render the form to a JavaScript string
    const formHtml = `{{ resource_component_form.as_p|escapejs }}`;

    function showModal(button) {
        const componentPk = button.getAttribute('data-target');

        // Create modal elements
        const modal = document.createElement('div');
        const modalContent = document.createElement('div');
        const closeBtn = document.createElement('span');
        const title = document.createElement('h2');
        const form = document.createElement('form');

        // Set content and styles
        title.textContent = 'Add Resource';
        closeBtn.textContent = 'Ã—';

        modal.style.cssText = `
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
            display: flex;
            justify-content: center;
            align-items: center;
        `;

        modalContent.style.cssText = `
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            position: relative;
            width: 50%;
            max-width: 500px;
            max-height: 80%;
            overflow-y: auto;
        `;

        closeBtn.style.cssText = `
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        `;

        // Set the form HTML
        form.innerHTML = formHtml;

        // Add submit button if it's not already in the form
        if (!form.querySelector('input[type="submit"]')) {
            const submitBtn = document.createElement('input');
            submitBtn.type = 'submit';
            submitBtn.value = 'Submit';
            submitBtn.style.cssText = `
                background-color: #4CAF50;
                color: white;
                padding: 10px 15px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                margin-top: 10px;
            `;
            form.appendChild(submitBtn);
        }

        // Assemble modal
        modalContent.appendChild(closeBtn);
        modalContent.appendChild(title);
        modalContent.appendChild(form);
        modal.appendChild(modalContent);

        // Add modal to body
        document.body.appendChild(modal);

        // Close modal when clicking the close button or outside the modal
        closeBtn.onclick = () => document.body.removeChild(modal);
        modal.onclick = (event) => {
            if (event.target === modal) {
                document.body.removeChild(modal);
            }
        };

        // Handle form submission
        form.onsubmit = (e) => {
            e.preventDefault();
            const formData = new FormData(form);

            // Get CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            // Make POST request
            fetch(`/en/user/administrator/components/${componentPk}/add-resource-component/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrfToken
                },
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log('Success:', data);
                alert('Resource component added successfully!');
                document.body.removeChild(modal);
                // Optionally, refresh the page or update the UI here
            })
            .catch((error) => {
                console.error('Error:', error);
                alert('An error occurred while adding the resource component.');
            });
        };

        console.log(`Modal opened for Component PK: ${componentPk}`);
    }
</script>
{% endblock %}
