{% extends '../_base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Learning Resources Create - LMS Admin" %}{% endblock %}

{% block extra_css %}
{% endblock %}

{% block content %}

<header class="mb-6 gradient-bg p-6 rounded-lg shadow-md">
    <h1 class="text-4xl font-bold text-white text-center mb-2">{% trans "Create Learning Resource for" %} {{ course.title }}</h1>
    <p class="text-lg text-white text-center">{% trans "Manage and Organize Your Course's Learning Resources" %}</p>
</header>

<nav class="flex mb-4" aria-label="{% trans 'Breadcrumb' %}">
    <ol class="inline-flex items-center space-x-1 md:space-x-3">
        <li class="inline-flex items-center">
            <a href="{% url 'administrator_dashboard' %}" class="inline-flex items-center text-sm font-medium text-gray-700 hover:text-blue-600">
                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg>
                {% trans "Dashboard" %}
            </a>
        </li>
        <li>
            <div class="flex items-center">
                <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
                <a href="{% url 'administrator_course_list' %}" class="ml-1 text-sm font-medium text-gray-700 hover:text-blue-600 md:ml-2">{% trans "Courses" %}</a>
            </div>
        </li>
        <li>
            <div class="flex items-center">
                <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
                <a href="{% url 'administrator_course_detail' course.id %}" class="ml-1 text-sm font-medium text-gray-700 hover:text-blue-600 md:ml-2">{{ course.title }}</a>
            </div>
        </li>
        <li>
            <div class="flex items-center">
                <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
                <a href="{% url 'administrator_course_resource_list' course.id %}" class="ml-1 text-sm font-medium text-gray-700 hover:text-blue-600 md:ml-2">{% trans "Learning Resources" %}</a>
            </div>
        </li>
        <li>
            <div class="flex items-center">
                <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
                <span class="ml-1 text-sm font-medium text-gray-500 md:ml-2">{% trans "Create Learning Resource" %}</span>
            </div>
        </li>
    </ol>
</nav>

<main class="container mx-auto">
    <!-- Learning Resource Form -->
    <form id="learning-resource-form" class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h2 class="text-2xl font-semibold mb-4">Create New Learning Resource</h2>
        <div class="mb-4">
            <label for="resource-title" class="block text-gray-700 font-bold mb-2">Resource Title</label>
            <input type="text" id="resource-title" name="title" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" required>
        </div>
        <div class="mb-4">
            <label for="resource-description" class="block text-gray-700 font-bold mb-2">Description</label>
            <textarea id="resource-description" name="description" rows="3" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"></textarea>
        </div>
        <div class="mb-4">
            <label for="resource-type" class="block text-gray-700 font-bold mb-2">Resource Type</label>
            <select id="resource-type" name="resource_type" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" required>
                <option value="SCORM">SCORM Package</option>
                <option value="VIDEO">Video</option>
                <option value="DOCUMENT">Document</option>
                <option value="PRESENTATION">Presentation</option>
                <option value="LINK">External Link</option>
                <option value="QUIZ">Quiz</option>
            </select>
        </div>
        <div id="resource-specific-fields" class="mb-4">
            <!-- Resource-specific fields will be dynamically added here -->
        </div>
        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-custom">Create Learning Resource</button>
    </form>

    <!-- Quiz Form (initially hidden) -->
    <form id="quiz-form" class="bg-white rounded-lg shadow-md p-6 mb-8 hidden">
        <h2 class="text-2xl font-semibold mb-4">Create New Quiz</h2>
        <div class="mb-4">
            <label for="quiz-title" class="block text-gray-700 font-bold mb-2">Quiz Title</label>
            <input type="text" id="quiz-title" name="title" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" required>
        </div>
        <div class="mb-4">
            <label for="quiz-description" class="block text-gray-700 font-bold mb-2">Description</label>
            <textarea id="quiz-description" name="description" rows="3" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"></textarea>
        </div>
        <div class="mb-4">
            <label for="time-limit" class="block text-gray-700 font-bold mb-2">Time Limit (minutes)</label>
            <input type="number" id="time-limit" name="time_limit" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
        </div>
        <div class="mb-4">
            <label for="passing-score" class="block text-gray-700 font-bold mb-2">Passing Score (%)</label>
            <input type="number" id="passing-score" name="passing_score" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" required>
        </div>
        <div class="mb-4">
            <label for="max-attempts" class="block text-gray-700 font-bold mb-2">Max Attempts</label>
            <input type="number" id="max-attempts" name="max_attempts" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" required>
        </div>

        <div id="questions-container">
            <!-- Questions will be dynamically added here -->
        </div>

        <button type="button" id="add-question" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-custom mt-4">Add Question</button>

        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-custom mt-4">Create Quiz</button>
    </form>
</main>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const learningResourceForm = document.getElementById('learning-resource-form');
    const quizForm = document.getElementById('quiz-form');
    const resourceType = document.getElementById('resource-type');
    const resourceSpecificFields = document.getElementById('resource-specific-fields');

    // Function to update resource-specific fields
    function updateResourceFields(type) {
        resourceSpecificFields.innerHTML = '';
        quizForm.classList.add('hidden');

        switch(type) {
            case 'SCORM':
                resourceSpecificFields.innerHTML = `
                    <div class="mb-4">
                        <label for="file-upload" class="block text-gray-700 font-bold mb-2">Upload File</label>
                        <input type="file" id="file-upload" name="file_upload" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" required>
                    </div>
                `;
                break;
            case 'VIDEO':
                resourceSpecificFields.innerHTML = `
                    <div class="mb-4">
                        <label for="file-upload" class="block text-gray-700 font-bold mb-2">Upload File</label>
                        <input type="file" id="file-upload" name="file_upload" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" required>
                    </div>
                `;
                break;
            case 'DOCUMENT':
            case 'PRESENTATION':
                resourceSpecificFields.innerHTML = `
                    <div class="mb-4">
                        <label for="file-upload" class="block text-gray-700 font-bold mb-2">Upload File</label>
                        <input type="file" id="file-upload" name="file_upload" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" required>
                    </div>
                `;
                break;
            case 'LINK':
                resourceSpecificFields.innerHTML = `
                    <div class="mb-4">
                        <label for="external-url" class="block text-gray-700 font-bold mb-2">External URL</label>
                        <input type="url" id="external-url" name="external_url" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" required>
                    </div>
                `;
                break;
            case 'QUIZ':
                quizForm.classList.remove('hidden');
                break;
        }
    }

    // Event listener for resource type change
    resourceType.addEventListener('change', (e) => updateResourceFields(e.target.value));

    // Initialize with the default selected type
    updateResourceFields(resourceType.value);

    // Event listener for learning resource form submission
    learningResourceForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const resourceData = Object.fromEntries(formData.entries());

        console.log('Learning Resource Data:', resourceData);
        // Here you would typically send this data to your backend API
        // For example: fetch('/api/learning-resources/', { method: 'POST', body: JSON.stringify(resourceData) })
    });

    // Quiz form functionality
    let questionCounter = 0;

    function addQuestion() {
        questionCounter++;
        const questionContainer = document.createElement('div');
        questionContainer.className = 'question-container bg-gray-100 p-4 rounded-lg mb-4';
        questionContainer.dataset.questionId = questionCounter;

        questionContainer.innerHTML = `
            <h3 class="text-xl font-semibold mb-2">Question ${questionCounter}</h3>
            <div class="mb-4">
                <label class="block text-gray-700 font-bold mb-2">Question Text</label>
                <textarea name="questions[${questionCounter}][text]" rows="2" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" required></textarea>
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 font-bold mb-2">Question Type</label>
                <select name="questions[${questionCounter}][question_type]" class="question-type w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" required>
                    <option value="MULTIPLE_CHOICE">Multiple Choice</option>
                    <option value="TRUE_FALSE">True/False</option>
                    <option value="SHORT_ANSWER">Short Answer</option>
                    <option value="ESSAY">Essay</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 font-bold mb-2">Points</label>
                <input type="number" name="questions[${questionCounter}][points]" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" required>
            </div>
            <div class="answer-container mb-4">
                <!-- Answer options will be dynamically added here -->
            </div>
            <button type="button" class="delete-question bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-custom">Delete Question</button>
        `;

        document.getElementById('questions-container').appendChild(questionContainer);

        // Add event listeners for the new elements
        questionContainer.querySelector('.question-type').addEventListener('change', (e) => updateAnswerOptions(questionCounter, e.target.value));
        questionContainer.querySelector('.delete-question').addEventListener('click', () => deleteQuestion(questionContainer));

        // Initialize with Multiple Choice by default
        updateAnswerOptions(questionCounter, 'MULTIPLE_CHOICE');
    }

    function updateAnswerOptions(questionId, questionType) {
        const answerContainer = document.querySelector(`[data-question-id="${questionId}"] .answer-container`);
        answerContainer.innerHTML = ''; // Clear existing content

        switch(questionType) {
            case 'MULTIPLE_CHOICE':
                answerContainer.innerHTML = `
                    <div class="choices-container mb-4">
                        <!-- Choices will be dynamically added here -->
                    </div>
                    <button type="button" class="add-choice bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-custom">Add Choice</button>
                `;
                answerContainer.querySelector('.add-choice').addEventListener('click', () => addChoice(questionId));
                // Add two choices by default
                addChoice(questionId);
                addChoice(questionId);
                break;
            case 'TRUE_FALSE':
                answerContainer.innerHTML = `
                    <div class="mb-2">
                        <label class="inline-flex items-center">
                            <input type="radio" name="questions[${questionId}][correct_answer]" value="true" class="form-radio h-5 w-5 text-blue-600" required>
                            <span class="ml-2">True</span>
                        </label>
                    </div>
                    <div>
                        <label class="inline-flex items-center">
                            <input type="radio" name="questions[${questionId}][correct_answer]" value="false" class="form-radio h-5 w-5 text-blue-600" required>
                            <span class="ml-2">False</span>
                        </label>
                    </div>
                `;
                break;
            case 'SHORT_ANSWER':
                answerContainer.innerHTML = `
                    <input type="text" name="questions[${questionId}][correct_answer]" placeholder="Correct Answer" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" required>
                `;
                break;
            case 'ESSAY':
                answerContainer.innerHTML = `
                    <textarea name="questions[${questionId}][answer_guideline]" rows="3" placeholder="Answer Guideline or Rubric" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"></textarea>
                `;
                break;
        }
    }

    function addChoice(questionId) {
        const choicesContainer = document.querySelector(`[data-question-id="${questionId}"] .choices-container`);
        const choiceCount = choicesContainer.children.length + 1;

        const choiceDiv = document.createElement('div');
        choiceDiv.className = 'choice-container flex items-center mb-2';
        choiceDiv.innerHTML = `
            <input type="text" name="questions[${questionId}][choices][${choiceCount}][text]" placeholder="Choice ${choiceCount}" class="flex-grow px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 mr-2" required>
            <label class="inline-flex items-center mr-2">
                <input type="checkbox" name="questions[${questionId}][choices][${choiceCount}][is_correct]" class="form-checkbox h-5 w-5 text-blue-600">
                <span class="ml-2 text-gray-700">Correct</span>
            </label>
            <button type="button" class="delete-choice bg-red-500 text-white px-2 py-1 rounded-lg hover:bg-red-600 transition-custom">Delete</button>
        `;

        choicesContainer.appendChild(choiceDiv);

        choiceDiv.querySelector('.delete-choice').addEventListener('click', () => deleteChoice(choiceDiv));
    }

    function deleteQuestion(questionContainer) {
        questionContainer.remove();
    }

    function deleteChoice(choiceContainer) {
        choiceContainer.remove();
    }

    document.getElementById('add-question').addEventListener('click', addQuestion);

    document.getElementById('quiz-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const quizData = Object.fromEntries(formData.entries());

        // Process questions and choices
        quizData.questions = [];
        document.querySelectorAll('.question-container').forEach((questionContainer, index) => {
            const questionId = questionContainer.dataset.questionId;
            const question = {
                text: formData.get(`questions[${questionId}][text]`),
                question_type: formData.get(`questions[${questionId}][question_type]`),
                points: formData.get(`questions[${questionId}][points]`),
            };

            switch(question.question_type) {
                case 'MULTIPLE_CHOICE':
                    question.choices = [];
                    questionContainer.querySelectorAll('.choice-container').forEach((choiceContainer, choiceIndex) => {
                        question.choices.push({
                            text: formData.get(`questions[${questionId}][choices][${choiceIndex + 1}][text]`),
                            is_correct: formData.get(`questions[${questionId}][choices][${choiceIndex + 1}][is_correct]`) === 'on'
                        });
                    });
                    break;
                case 'TRUE_FALSE':
                    question.correct_answer = formData.get(`questions[${questionId}][correct_answer]`);
                    break;
                case 'SHORT_ANSWER':
                    question.correct_answer = formData.get(`questions[${questionId}][correct_answer]`);
                    break;
                case 'ESSAY':
                    question.answer_guideline = formData.get(`questions[${questionId}][answer_guideline]`);
                    break;
            }

            quizData.questions.push(question);
        });

        console.log('Quiz Data:', quizData);
        // Here you would typically send this data to your backend API
        // For example: fetch('/api/quizzes/', { method: 'POST', body: JSON.stringify(quizData) })
    });
});
</script>
{% endblock %}