{% extends '../_base.html' %}
{% load static i18n %}

{% block title %}{{ course.title }} - LMS Admin{% endblock %}

{% block extra_css %}
<style>
    .tab-content {
        display: none;
    }
    .tab-content.active {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div>
    <!-- Header -->
    <header class="mb-6 gradient-bg p-6 rounded-lg shadow-md">
        <h1 class="text-4xl font-bold text-white text-center mb-2">{{ course.title }}</h1>
        <p class="text-xl text-blue-100 text-center">{% trans "Course ID:" %} {{ course.id }}</p>
    </header>
    

    <!-- Breadcrumbs -->
    <nav class="flex mb-4" aria-label="Breadcrumb">
        <ol class="inline-flex items-center space-x-1 md:space-x-3">
            <li class="inline-flex items-center">
                <a href="#" class="inline-flex items-center text-sm font-medium text-gray-700 hover:text-blue-600">
                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg>
                    {% trans "Dashboard" %}
                </a>
            </li>
            <li>
                <div class="flex items-center">
                    <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
                    <a href="#" class="ml-1 text-sm font-medium text-gray-700 hover:text-blue-600 md:ml-2">{% trans "Courses" %}</a>
                </div>
            </li>
            <li aria-current="page">
                <div class="flex items-center">
                    <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
                    <span class="ml-1 text-sm font-medium text-gray-500 md:ml-2">{{ course.title }}</span>
                </div>
            </li>
        </ol>
    </nav>

    <div class="flex flex-wrap -mx-4">
        <!-- Left Column -->
        <div class="w-full lg:w-1/3 px-4 mb-8">
            <div class="bg-white rounded-lg card-shadow overflow-hidden">
                {% if course.cover_image %}
                    <img src="{{ course.cover_image.url }}" alt="{{ course.title }}" class="w-full h-48 object-cover">
                {% else %}
                    <div class="w-full h-48 bg-gray-300 flex items-center justify-center">
                        <span class="text-gray-500">{% trans "No Cover Image" %}</span>
                    </div>
                {% endif %}
                <div class="p-6">
                    <h2 class="text-2xl font-bold text-primary mb-2">{{ course.title }}</h2>
                    <p class="text-secondary mb-4">{% trans "Course ID:" %} {{ course.id }}</p>
                    <div class="flex justify-between mb-4">
                        <button class="bg-primary text-white px-4 py-2 rounded hover:bg-blue-700 transition">{% trans "Edit Course" %}</button>
                        <button class="bg-accent text-white px-4 py-2 rounded hover:bg-red-700 transition">{% trans "Unpublish" %}</button>
                    </div>
                    <div class="flex justify-between mb-4">
                        <button onclick="previewResource()" class="bg-gray-200 text-gray-800 px-4 py-2 rounded hover:bg-gray-300 transition">{% trans "Preview" %}</button>
                        <button class="bg-gray-200 text-gray-800 px-4 py-2 rounded hover:bg-gray-300 transition">{% trans "Analytics" %}</button>
                    </div>
                    <div class="mt-6">
                        <h3 class="text-xl font-semibold mb-4">{% trans "Quick Actions" %}</h3>
                        <ul class="space-y-2">
                            <li><a href="#" class="text-blue-600 hover:underline"><i class="fas fa-user-plus mr-2"></i>{% trans "Add New Student" %}</a></li>
                            <li><a href="#" class="text-blue-600 hover:underline"><i class="fas fa-calendar-alt mr-2"></i>{% trans "Schedule Live Session" %}</a></li>
                            <li><a href="#" class="text-blue-600 hover:underline"><i class="fas fa-chart-bar mr-2"></i>{% trans "Generate Report" %}</a></li>
                            <li><a href="#" class="text-blue-600 hover:underline"><i class="fas fa-envelope mr-2"></i>{% trans "Send Announcement" %}</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column -->
<div class="w-full lg:w-2/3 px-4">
    <div class="bg-white rounded-lg card-shadow p-6 mb-8">
        <h2 class="text-xl font-semibold mb-4">{% trans "Course Overview" %}</h2>
        <p class="mb-4">{{ course.description }}</p>
        <div class="grid grid-cols-2 gap-4">
            <div>
                <p><strong>{% trans "Category:" %}</strong> {{ course.category }}</p>
                <p><strong>{% trans "Created by:" %}</strong> {{ course.created_by }}</p>
                <p><strong>{% trans "Last Updated:" %}</strong> {{ course.updated_at|date:"F d, Y" }}</p>
            </div>
            <div>
                <p><strong>{% trans "Total Enrollments:" %}</strong> {{ total_enrollments }}</p>
                <p><strong>{% trans "Active Enrollments:" %}</strong> {{ total_active_enrollments }}</p>
                <p><strong>{% trans "Course Deliveries:" %}</strong> {{ total_deliveries }}</p>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-lg card-shadow p-6">
        <ul class="flex border-b border-gray-200 mb-6" id="mainTabs">
            <li class="mr-1">
                <a class="bg-white inline-block py-2 px-4 text-blue-500 hover:text-blue-800 font-semibold active" href="#" data-tab="content">
                    {% trans "Course Content" %}
                </a>
            </li>
            <li class="mr-1">
                <a class="bg-white inline-block py-2 px-4 text-blue-500 hover:text-blue-800 font-semibold" href="#" data-tab="enrollments">
                    {% trans "Enrollments" %}
                </a>
            </li>
            <li class="mr-1">
                <a class="bg-white inline-block py-2 px-4 text-blue-500 hover:text-blue-800 font-semibold" href="#" data-tab="deliveries">
                    {% trans "Course Deliveries" %}
                </a>
            </li>
        </ul>

        <div id="content" class="tab-content active">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold">{% trans "Course Content" %}</h3>
                <button class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition" onclick="showAddResourceModal()">
                    <i class="fas fa-plus mr-2"></i>{% trans "Add New Resource" %}
                </button>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="px-4 py-2 text-left">{% trans "Title" %}</th>
                            <th class="px-4 py-2 text-left">{% trans "Type" %}</th>
                            <th class="px-4 py-2 text-left">{% trans "Order" %}</th>
                            <th class="px-4 py-2 text-left">{% trans "Last Updated" %}</th>
                            <th class="px-4 py-2 text-left">{% trans "Actions" %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for resource in learning_resources %}
                        <tr>
                            <td class="px-4 py-2">
                                <div class="flex items-center">
                                    <span class="resource-type-icon w-8 h-8 rounded-full flex items-center justify-center mr-2
                                        {% if resource.resource_type == 'SCORM' %}
                                            bg-blue-100 text-blue-600
                                        {% elif resource.resource_type == 'VIDEO' %}
                                            bg-red-100 text-red-600
                                        {% elif resource.resource_type == 'DOCUMENT' %}
                                            bg-yellow-100 text-yellow-600
                                        {% elif resource.resource_type == 'PRESENTATION' %}
                                            bg-orange-100 text-orange-600
                                        {% elif resource.resource_type == 'LINK' %}
                                            bg-purple-100 text-purple-600
                                        {% elif resource.resource_type == 'QUIZ' %}
                                            bg-green-100 text-green-600
                                        {% else %}
                                            bg-gray-100 text-gray-600
                                        {% endif %}">
                                        <i class="fas fa-{{ resource.get_resource_type_display|lower }}-alt"></i>
                                    </span>
                                    {{ resource.title }}
                                </div>
                            </td>
                            <td class="px-4 py-2">{{ resource.get_resource_type_display }}</td>
                            <td class="px-4 py-2">{{ resource.order }}</td>
                            <td class="px-4 py-2">{{ resource.updated_at|date:"F d, Y" }}</td>
                            <td class="px-4 py-2">
                                <button class="text-blue-500 hover:text-blue-700 mr-2" onclick="editResource('{{ resource.id }}')"><i class="fas fa-edit"></i></button>
                                <button class="text-green-500 hover:text-green-700 mr-2" onclick="previewResource('{{ resource.id }}')"><i class="fas fa-eye"></i></button>
                                <button class="text-red-500 hover:text-red-700" onclick="deleteResource('{{ resource.id }}')"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div id="enrollments" class="tab-content">
            <h3 class="text-xl font-semibold mb-4">{% trans "Recent Enrollments" %}</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="py-2 px-4 text-left">{% trans "User" %}</th>
                            <th class="py-2 px-4 text-left">{% trans "Delivery" %}</th>
                            <th class="py-2 px-4 text-left">{% trans "Enrollment Date" %}</th>
                            <th class="py-2 px-4 text-left">{% trans "Status" %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for enrollment in recent_enrollments %}
                        <tr>
                            <td class="py-2 px-4">{{ enrollment.user.username }}</td>
                            <td class="py-2 px-4">{{ enrollment.course_delivery.title }}</td>
                            <td class="py-2 px-4">{{ enrollment.enrollment_date|date:"F d, Y H:i" }}</td>
                            <td class="py-2 px-4">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                    {% if enrollment.status == 'ENROLLED' %}
                                        bg-green-100 text-green-800
                                    {% elif enrollment.status == 'IN_PROGRESS' %}
                                        bg-blue-100 text-blue-800
                                    {% elif enrollment.status == 'COMPLETED' %}
                                        bg-purple-100 text-purple-800
                                    {% else %}
                                        bg-red-100 text-red-800
                                    {% endif %}">
                                    {{ enrollment.get_status_display }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div id="deliveries" class="tab-content">
            <h3 class="text-xl font-semibold mb-4">{% trans "Course Deliveries" %}</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="py-2 px-4 text-left">{% trans "Title" %}</th>
                            <th class="py-2 px-4 text-left">{% trans "Start Date" %}</th>
                            <th class="py-2 px-4 text-left">{% trans "Total Enrollments" %}</th>
                            <th class="py-2 px-4 text-left">{% trans "Active Enrollments" %}</th>
                            <th class="py-2 px-4 text-left">{% trans "Status" %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for delivery in course_deliveries %}
                        <tr>
                            <td class="py-2 px-4">{{ delivery.title }}</td>
                            <td class="py-2 px-4">{{ delivery.start_date|date:"F d, Y" }}</td>
                            <td class="py-2 px-4">{{ delivery.total_enrollments }}</td>
                            <td class="py-2 px-4">{{ delivery.active_enrollments }}</td>
                            <td class="py-2 px-4">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                    {% if delivery.status == 'ACTIVE' %}
                                        bg-green-100 text-green-800
                                    {% elif delivery.status == 'DRAFT' %}
                                        bg-yellow-100 text-yellow-800
                                    {% elif delivery.status == 'COMPLETED' %}
                                        bg-blue-100 text-blue-800
                                    {% else %}
                                        bg-gray-100 text-gray-800
                                    {% endif %}">
                                    {{ delivery.get_status_display }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>


<!-- Add Resource Modal -->
<div id="addResourceModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden justify-center items-center">
    <div class="bg-white rounded-lg p-8 max-w-md w-full">
        <h2 class="text-2xl font-semibold mb-4">{% trans "Add New Resource" %}</h2>
        <form id="addResourceForm" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1" for="id_title">{% trans "Title" %}</label>
                <input type="text" id="id_title" name="title" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1" for="id_resource_type">{% trans "Resource Type" %}</label>
                <select id="id_resource_type" name="resource_type" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    <option value="">{% trans "Select a type" %}</option>
                    <option value="VIDEO">{% trans "Video" %}</option>
                    <option value="DOCUMENT">{% trans "Document" %}</option>
                    <option value="PRESENTATION">{% trans "Presentation" %}</option>
                    <option value="LINK">{% trans "Link" %}</option>
                    <option value="QUIZ">{% trans "Quiz" %}</option>
                    <option value="SCORM">{% trans "SCORM" %}</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1" for="id_description">{% trans "Description" %}</label>
                <textarea id="id_description" name="description" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></textarea>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1" for="id_content">{% trans "Content File" %}</label>
                <input type="file" id="id_content" name="content" class="mt-1 block w-full text-sm text-gray-500
                    file:mr-4 file:py-2 file:px-4
                    file:rounded-full file:border-0
                    file:text-sm file:font-semibold
                    file:bg-blue-50 file:text-blue-700
                    hover:file:bg-blue-100
                ">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1" for="id_external_url">{% trans "External URL" %}</label>
                <input type="url" id="id_external_url" name="external_url" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1" for="id_order">{% trans "Order" %}</label>
                <input type="number" id="id_order" name="order" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            </div>
            <div class="flex justify-end">
                <button type="button" class="bg-gray-300 text-gray-800 px-4 py-2 rounded mr-2 hover:bg-gray-400 transition duration-150 ease-in-out" onclick="closeAddResourceModal()">{% trans "Cancel" %}</button>
                <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition duration-150 ease-in-out">{% trans "Add Resource" %}</button>
            </div>
        </form>
    </div>
</div>

<!-- Preview Modal -->
<div id="previewModal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
    <div class="modal-backdrop absolute inset-0"></div>
    <div class="bg-white rounded-lg shadow-2xl z-10 overflow-hidden flex" data-aos="zoom-in" style="width:95%; height:90%;">
        <!-- Learning Path Sidebar -->
        <div class="w-1/4 bg-gray-50 p-6 overflow-auto border-r">
            <h3 class="text-xl font-bold mb-4">{% trans "Learning Path" %}</h3>
            <div id="learningPath" class="space-y-4">
                <!-- Learning path items will be inserted here -->
            </div>
        </div>


        <!-- Main Content Area -->
        <div class="w-3/4 flex flex-col">
            <div class="flex justify-between items-center p-6 bg-gray-50 border-b">
                <h3 class="text-2xl font-bold text-gray-800" id="modalTitle">{% trans "Course Resource Preview" %}</h3>
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 transition duration-150 ease-in-out">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="flex-1 p-6 overflow-auto">
                <div id="modalContent" class="h-full">
                    <!-- Resource Content -->
                    <div id="resourceContent" class="border p-6 rounded-lg shadow-md mb-6">
                        <!-- Content will be loaded here based on selection -->
                    </div>
                    
                    <!-- Resource Metadata -->
                    <div class="bg-gray-50 p-6 rounded-lg shadow-md">
                        <h4 class="text-xl font-semibold mb-4">{% trans "Resource Metadata" %}</h4>
                        <div id="resourceMetadata" class="grid grid-cols-2 gap-4">
                            <!-- Metadata will be loaded here based on selection -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
    
{% block extra_js %}
<script>
    const tabLinks = document.querySelectorAll('#mainTabs a');
    const tabContents = document.querySelectorAll('.tab-content');
    const course_id = "{{ course.id }}";

    tabLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const tabId = link.getAttribute('data-tab');
            
            tabLinks.forEach(l => l.classList.remove('active', 'border-b-2', 'border-blue-500'));
            tabContents.forEach(c => c.classList.remove('active'));
            
            link.classList.add('active', 'border-b-2', 'border-blue-500');
            document.getElementById(tabId).classList.add('active');
        });
    });      
    
    function showAddResourceModal() {
        document.getElementById('addResourceModal').classList.remove('hidden');
        document.getElementById('addResourceModal').classList.add('flex');
    }

    function closeAddResourceModal() {
        document.getElementById('addResourceModal').classList.add('hidden');
        document.getElementById('addResourceModal').classList.remove('flex');
    }

    
        document.addEventListener('DOMContentLoaded', function() {
            const resourceTypeSelect = document.getElementById('id_resource_type');
            const contentFileDiv = document.getElementById('id_content').parentNode;
            const externalUrlDiv = document.getElementById('id_external_url').parentNode;
        
            function toggleFields() {
                const selectedType = resourceTypeSelect.value;
                
                if (selectedType === 'LINK') {
                    contentFileDiv.style.display = 'none';
                    externalUrlDiv.style.display = 'block';
                } else if (selectedType === 'QUIZ') {
                    contentFileDiv.style.display = 'none';
                    externalUrlDiv.style.display = 'none';
                } else {
                    contentFileDiv.style.display = 'block';
                    externalUrlDiv.style.display = 'none';
                }
            }
        
            resourceTypeSelect.addEventListener('change', toggleFields);
            toggleFields(); // Call once to set initial state
        });
        

    document.getElementById('addResourceForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const course_id = '{{ course.id }}'; // Make sure this variable is available in your template
    
        fetch(`/en/user/administrator/course/${course_id}/add-resource/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Add the new resource to the table
                const tableBody = document.querySelector('#content table tbody');
                const newRow = `
                    <tr>
                        <td class="px-4 py-2">
                            <div class="flex items-center">
                                <span class="resource-type-icon w-8 h-8 rounded-full flex items-center justify-center mr-2 bg-blue-100 text-blue-600">
                                    <i class="fas fa-file-alt"></i>
                                </span>
                                ${data.resource.title}
                            </div>
                        </td>
                        <td class="px-4 py-2">${data.resource.resource_type}</td>
                        <td class="px-4 py-2">${data.resource.order}</td>
                        <td class="px-4 py-2">${data.resource.updated_at}</td>
                        <td class="px-4 py-2">
                            <button class="text-blue-500 hover:text-blue-700 mr-2" onclick="editResource('${data.resource.id}')"><i class="fas fa-edit"></i></button>
                            <button class="text-green-500 hover:text-green-700 mr-2" onclick="previewResource('${data.resource.id}')"><i class="fas fa-eye"></i></button>
                            <button class="text-red-500 hover:text-red-700" onclick="deleteResource('${data.resource.id}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
                tableBody.insertAdjacentHTML('beforeend', newRow);
                
                // Close the modal and reset the form
                closeAddResourceModal();
                document.getElementById('addResourceForm').reset();
            } else {
                // Display errors
                console.error('Form submission errors:', data.errors);
                // You can display these errors in the modal if you want
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    });
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function editResource(id) {
        // Implement edit functionality
        console.log('Editing resource with id:', id);
    }

    function previewResource(id) {
        // Implement preview functionality
        console.log('Previewing resource with id:', id);
    }

    function deleteResource(id) {
        // Implement delete functionality
        console.log('Deleting resource with id:', id);
    }
</script>
<script src="https://unpkg.com/aos@next/dist/aos.js"></script>
<script>
    AOS.init();
    const scorm_url = "{{ course.scorm_url|escapejs }}";
    const resources = [
        {% for resource in learning_resources %}
        {
            type: '{{ resource.resource_type|lower }}',
            title: '{{ resource.title|escapejs }}',
            icon: getIconForResourceType('{{ resource.resource_type }}'),
            content: getContentForResourceType(
                '{{ resource.resource_type }}', 
                '{% if resource.content %}{{ resource.content.url|default:""|escapejs }}{% else %}{% endif %}',
                '{{ resource.external_url|default:""|escapejs }}',
                '{{ resource.launch_url|default:""|escapejs }}',
                '{{ resource.scorm_details.scorm_package_id }}',
            ),
            metadata: {
                '{% trans "Description" %}': '{{ resource.description|escapejs }}',
                '{% trans "Type" %}': '{{ resource.get_resource_type_display }}',
                '{% trans "Created" %}': '{{ resource.created_at|date:"F d, Y" }}',
                '{% trans "Last Updated" %}': '{{ resource.updated_at|date:"F d, Y" }}',
                '{% trans "Order" %}': '{{ resource.order }}',
                {% if resource.resource_type == 'DOCUMENT' %}
                '{% trans "File Type" %}': 'NA',
                {% elif resource.resource_type == 'VIDEO' %}
                '{% trans "Duration" %}': 'N/A', // You'd need to implement video duration extraction
                {% elif resource.resource_type == 'QUIZ' %}
                '{% trans "Questions" %}': 'N/A', // You'd need to implement quiz question count
                {% endif %}
            }
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    console.log(resources);

    function getIconForResourceType(type) {
        const iconMap = {
            'SCORM': 'fas fa-cube',
            'VIDEO': 'fas fa-video',
            'DOCUMENT': 'fas fa-file-alt',
            'PRESENTATION': 'fas fa-file-powerpoint',
            'LINK': 'fas fa-link',
            'QUIZ': 'fas fa-question-circle'
        };
        return iconMap[type] || 'fas fa-file';
    }

    function getContentForResourceType(type, contentUrl, externalUrl, launchUrl, scormPackageId) {
        switch (type) {
            case 'VIDEO':
                return contentUrl ? `<div class="aspect-w-16" data-aos="fade-up"><video src="${contentUrl}" controls class="w-full"></video></div>` : 
                    `<div class="bg-gray-100 p-6 rounded-lg" data-aos="fade-up"><p class="font-bold mb-4">{% trans "Video Resource" %}</p><p>{% trans "No video file available." %}</p></div>`;
                    case 'DOCUMENT':
                    if (contentUrl) {
                        const fileExtension = contentUrl.split('.').pop().toLowerCase();
                        if (fileExtension === 'pdf') {
                            return `
                                <div class="bg-gray-100 p-6 rounded-lg" data-aos="fade-up">
                                    <p class="font-bold mb-4">{% trans "Document Preview" %}</p>
                                    <div class="pdf-container" style="width: 100%; height: 600px;">
                                        <object data="${contentUrl}" type="application/pdf" width="100%" height="100%">
                                            <p>{% trans "It appears your browser doesn't support embedded PDFs. You can " %}<a href="${contentUrl}" target="_blank" class="text-blue-500 hover:underline">{% trans "download the PDF" %}</a> {% trans "to view it." %}</p>
                                        </object>
                                    </div>
                                    <p class="mt-4"><a href="${contentUrl}" target="_blank" class="text-blue-500 hover:underline">{% trans "Open in new tab" %}</a></p>
                                </div>
                            `;
                        } else {
                            return `
                                <div class="bg-gray-100 p-6 rounded-lg" data-aos="fade-up">
                                    <p class="font-bold mb-4">{% trans "Document Preview" %}</p>
                                    <p>{% trans "This is a preview of the document." %} <a href="${contentUrl}" target="_blank" class="text-blue-500 hover:underline">{% trans "View full document" %}</a></p>
                                </div>
                            `;
                        }
                    } else {
                        return `
                            <div class="bg-gray-100 p-6 rounded-lg" data-aos="fade-up">
                                <p class="font-bold mb-4">{% trans "Document Resource" %}</p>
                                <p>{% trans "No document file available." %}</p>
                            </div>
                        `;
                    };
            case 'QUIZ':
                return `<div class="bg-gray-100 p-6 rounded-lg" data-aos="fade-up"><p class="font-bold mb-4">{% trans "Quiz Preview" %}</p><p>{% trans "This quiz is available in the course. Click to attempt." %}</p></div>`;
            case 'SCORM':
                return `<div class="bg-gray-200 p-6 rounded-lg text-center" data-aos="fade-up"><p class="mb-4">{% trans "This is a SCORM package. Click the button below to launch it." %}</p><button onclick="launchScorm('${scormPackageId}')" class="bg-blue-500 text-white px-6 py-2 rounded-full shadow hover:bg-blue-600 transition duration-300 ease-in-out transform hover:-translate-y-1 hover:scale-105">{% trans "Launch SCORM Package" %}</button></div>`;
            case 'PRESENTATION':
                return contentUrl ? `<div class="bg-gray-100 p-6 rounded-lg text-center" data-aos="fade-up"><p class="font-bold mb-4">{% trans "Presentation Preview" %}</p><p>{% trans "This is a presentation." %} <a href="${contentUrl}" target="_blank" class="text-blue-500 hover:underline">{% trans "View presentation" %}</a></p></div>` :
                    `<div class="bg-gray-100 p-6 rounded-lg" data-aos="fade-up"><p class="font-bold mb-4">{% trans "Presentation Resource" %}</p><p>{% trans "No presentation file available." %}</p></div>`;
            case 'LINK':
                return externalUrl ? `<div class="bg-gray-100 p-6 rounded-lg" data-aos="fade-up"><p class="font-bold mb-4">{% trans "External Resource" %}</p><a href="${externalUrl}" target="_blank" class="text-blue-500 hover:underline">${externalUrl}</a><p class="mt-4">{% trans "Click the link above to access the external resource. Please note that this will open in a new tab." %}</p></div>` :
                    `<div class="bg-gray-100 p-6 rounded-lg" data-aos="fade-up"><p class="font-bold mb-4">{% trans "External Resource" %}</p><p>{% trans "No external URL provided." %}</p></div>`;
            default:
                return `<div class="bg-gray-100 p-6 rounded-lg" data-aos="fade-up"><p class="font-bold mb-4">{% trans "Resource Preview" %}</p><p>{% trans "Preview not available for this resource type." %}</p></div>`;
        }
    }

    function previewResource() {
        const modal = document.getElementById('previewModal');
        modal.classList.remove('hidden');
        renderLearningPath();
        showResource(0);
    }

    function renderLearningPath() {
        const pathContainer = document.getElementById('learningPath');
        pathContainer.innerHTML = resources.map((resource, index) => `
            <div class="learning-path-item flex items-start p-2 cursor-pointer hover:bg-gray-200 rounded transition duration-300 ease-in-out" onclick="showResource(${index})">
                <div class="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center mr-3 z-10">
                    ${index + 1}
                </div>
                <div>
                    <h4 class="font-semibold">${resource.title}</h4>
                    <p class="text-sm text-gray-600"><i class="${resource.icon} mr-1"></i>${resource.type}</p>
                </div>
            </div>
        `).join('');
    }

    function showResource(index) {
        const resource = resources[index];
        const contentDiv = document.getElementById('resourceContent');
        const metadataDiv = document.getElementById('resourceMetadata');
        const modalTitle = document.getElementById('modalTitle');
        
        modalTitle.textContent = resource.title;
        
        contentDiv.innerHTML = resource.content;

        contentDiv.classList.remove('h-full');
        
        metadataDiv.innerHTML = Object.entries(resource.metadata).map(([key, value]) => 
            `<div data-aos="fade-up" data-aos-delay="100"><strong class="text-gray-700">${key}:</strong> ${value}</div>`
        ).join('');

        
        // Highlight active item in learning path
        document.querySelectorAll('.learning-path-item').forEach((item, i) => {
            if (i === index) {
                item.classList.add('bg-blue-100');
            } else {
                item.classList.remove('bg-blue-100');
            }
        });
        
        AOS.refresh();
    }

    function launchScorm(packageId) {
        const userId = '{{ SCORM_PLAYER_USER_ID }}';
        const apiUrl = '{{ SCORM_API_BASE_URL }}/api/attempts/start_attempt/';
        const token = '{{ SCORM_PLAYER_API_TOKEN }}';
    
        const formData = new FormData();
        formData.append('user_id', userId);
        formData.append('package_id', packageId);
    
        fetch(apiUrl, {
            method: 'POST',
            body: formData,
            headers: {
                'Authorization': 'Bearer ' + token
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            const launchUrl = `{{ SCORM_API_BASE_URL }}/launch/${data.id}/`;
            launchScormPackage(launchUrl);
        })
        .catch(error => {
            console.error('Error launching SCORM package:', error);
            alert('Failed to launch SCORM package. Please try again.');
        });
    }
    
    function launchScormPackage(url) {
        const contentDiv = document.getElementById('resourceContent');
        const metadataDiv = document.getElementById('resourceMetadata');
        
        // Expand the content div to full height
        contentDiv.classList.add('h-full');
        
        contentDiv.innerHTML = `
            <div class="w-full h-full flex flex-col">
                <iframe src="${url}" allowfullscreen class="w-full flex-grow border-none"></iframe>
            </div>
        `;
    }

    function closeModal() {
        const modal = document.getElementById('previewModal');
        modal.classList.add('hidden');
        
        // Find and remove the SCORM iframe if it exists
        const scormIframe = document.querySelector('#resourceContent iframe');
        if (scormIframe) {
            scormIframe.remove();
        }
        
        // Reset the content div
        const contentDiv = document.getElementById('resourceContent');
        contentDiv.innerHTML = '';
        contentDiv.classList.remove('h-full');
        
        // Reset the metadata div
        const metadataDiv = document.getElementById('resourceMetadata');
        metadataDiv.innerHTML = '';
    }

    // Close modal when clicking outside
    document.getElementById('previewModal').addEventListener('click', function(event) {
        if (event.target === this) {
            closeModal();
        }
    });
</script>
{% endblock %}